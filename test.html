<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Theory Modes</title>
    <style>
        :root {
            --theme-color: #00ffcc;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #2c2c2c);
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            background: #2a2a2a;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(var(--theme-color-rgb, 0, 255, 204), 0.2);
            transition: transform 0.3s ease;
        }
        .container:hover {
            transform: translateY(-5px);
        }
        h1 {
            text-align: center;
            color: var(--theme-color);
            text-shadow: 0 0 10px rgba(var(--theme-color-rgb, 0, 255, 204), 0.5);
            margin-bottom: 20px;
        }
        .relative-modes {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            color: #e0e0e0;
            background: #333;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(var(--theme-color-rgb, 0, 255, 204), 0.1);
        }
        .relative-modes span {
            color: var(--theme-color);
            font-weight: bold;
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        select, input[type="color"] {
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background: #3a3a3a;
            color: #e0e0e0;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        select:hover, input[type="color"]:hover {
            background: #4a4a4a;
        }
        input[type="color"] {
            width: 50px;
            height: 40px;
            padding: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        th {
            background: var(--theme-color);
            color: #1a1a1a;
            text-transform: uppercase;
            font-weight: bold;
        }
        td {
            background: #333;
        }
        tr:hover td {
            background: #444;
        }
        .canvas-container {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }
        canvas {
            background: #333;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(var(--theme-color-rgb, 0, 255, 204), 0.1);
        }
        .canvas-label {
            font-size: 16px;
            color: var(--theme-color);
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        #fretboardCanvas {
            margin-bottom: 20px;
        }
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            .controls {
                flex-direction: column;
                align-items: center;
            }
            select, input[type="color"] {
                width: 100%;
            }
            th, td {
                font-size: 14px;
                padding: 10px;
            }
            .relative-modes {
                font-size: 16px;
            }
            canvas {
                width: 100%;
            }
            .canvas-label {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Music Theory Modes</h1>
        <div class="controls">
            <select id="notationSelect">
                <option value="sharp">Sharps</option>
                <option value="flat">Flats</option>
            </select>
            <select id="tuningSelect">
                <option value="standard">Standard Tuning</option>
                <option value="dropd">Drop D Tuning</option>
                <option value="openg">Open G Tuning</option>
                <option value="dadgad">DADGAD Tuning</option>
                <option value="opend">Open D Tuning</option>
                <option value="openc">Open C Tuning</option>
                <option value="doubledropd">Double Drop D Tuning</option>
            </select>
            <select id="stringOrderSelect">
                <option value="highBottom">High String Bottom</option>
                <option value="lowBottom">Low String Bottom</option>
            </select>
            <input type="color" id="themeColor" value="#00ffcc" title="Select Theme Color">
            <select id="keySelect">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="D">D</option>
                <option value="D#">D#</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
                <option value="A">A</option>
                <option value="A#">A#</option>
                <option value="B">B</option>
            </select>
            <select id="modeSelect">
                <!-- Major Scale Modes -->
                <option value="Ionian">Ionian (Major)</option>
                <option value="Dorian">Dorian</option>
                <option value="Phrygian">Phrygian</option>
                <option value="Lydian">Lydian</option>
                <option value="Mixolydian">Mixolydian</option>
                <option value="Aeolian">Aeolian (Natural Minor)</option>
                <option value="Locrian">Locrian</option>
                <!-- Pentatonic Scales -->
                <option value="MajorPentatonic">Major Pentatonic</option>
                <option value="MinorPentatonic">Minor Pentatonic</option>
                <!-- Harmonic Minor and Modes -->
                <option value="HarmonicMinor">Harmonic Minor</option>
                <option value="LocrianNat6">Locrian ♮6</option>
                <option value="IonianAug">Ionian Augmented</option>
                <option value="DorianSharp4">Dorian ♯4</option>
                <option value="PhrygianDominant">Phrygian Dominant</option>
                <option value="LydianSharp2">Lydian ♯2</option>
                <option value="SuperLocrianBB7">Super Locrian ♭♭7</option>
                <!-- Melodic Minor and Modes -->
                <option value="MelodicMinor">Melodic Minor</option>
                <option value="DorianFlat2">Dorian ♭2</option>
                <option value="LydianAugmented">Lydian Augmented</option>
                <option value="LydianDominant">Lydian Dominant</option>
                <option value="MixolydianFlat6">Mixolydian ♭6</option>
                <option value="LocrianNat2">Locrian ♮2</option>
                <option value="Altered">Altered Scale (Super Locrian)</option>
                <!-- Other Scales -->
                <option value="WholeTone">Whole Tone</option>
                <option value="DiminishedHW">Diminished (Half–Whole)</option>
                <option value="DiminishedWH">Diminished (Whole–Half)</option>
                <option value="Blues">Blues Scale</option>
                <!-- Bebop Scales -->
                <option value="BebopMajor">Bebop Major</option>
                <option value="BebopDominant">Bebop Dominant</option>
                <option value="BebopDorian">Bebop Dorian</option>
            </select>
        </div>
        <div id="relativeModes" class="relative-modes"></div>
        <table id="modeTable">
            <thead>
                <tr>
                    <th>Property</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="canvas-container">
            <div class="canvas-label">Guitar Fretboard <span id="fretboardKeyMode"></span></div>
            <canvas id="fretboardCanvas" width="840" height="150"></canvas>
            <div class="canvas-label">Piano Roll <span id="pianoKeyMode"></span></div>
            <canvas id="pianoCanvas" width="840" height="100"></canvas>
        </div>
    </div>
    <script>
        let currentNotation = 'sharp';
        let currentTuning = 'standard';
        let currentStringOrder = 'highBottom';
        let themeColor = '#00ffcc';
        let modesData = {};
        const modes = ["Ionian", "Dorian", "Phrygian", "Lydian", "Mixolydian", "Aeolian", "Locrian", "MajorPentatonic", "MinorPentatonic", "HarmonicMinor", "LocrianNat6", "IonianAug", "DorianSharp4", "PhrygianDominant", "LydianSharp2", "SuperLocrianBB7", "MelodicMinor", "DorianFlat2", "LydianAugmented", "LydianDominant", "MixolydianFlat6", "LocrianNat2", "Altered", "WholeTone", "DiminishedHW", "DiminishedWH", "Blues", "BebopMajor", "BebopDominant", "BebopDorian"];
        const sharpNotes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const flatNotes = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
        const intervalPatterns = {
            Ionian: ["Root", "Major 2nd", "Major 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Major 7th"],
            Dorian: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Minor 7th"],
            Phrygian: ["Root", "Minor 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Minor 6th", "Minor 7th"],
            Lydian: ["Root", "Major 2nd", "Major 3rd", "Augmented 4th", "Perfect 5th", "Major 6th", "Major 7th"],
            Mixolydian: ["Root", "Major 2nd", "Major 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Minor 7th"],
            Aeolian: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Minor 6th", "Minor 7th"],
            Locrian: ["Root", "Minor 2nd", "Minor 3rd", "Perfect 4th", "Diminished 5th", "Minor 6th", "Minor 7th"],
            MajorPentatonic: ["Root", "Major 2nd", "Major 3rd", "Perfect 5th", "Major 6th"],
            MinorPentatonic: ["Root", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Minor 7th"],
            HarmonicMinor: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Minor 6th", "Major 7th"],
            LocrianNat6: ["Root", "Minor 2nd", "Minor 3rd", "Perfect 4th", "Diminished 5th", "Major 6th", "Minor 7th"],
            IonianAug: ["Root", "Major 2nd", "Major 3rd", "Perfect 4th", "Augmented 5th", "Major 6th", "Major 7th"],
            DorianSharp4: ["Root", "Major 2nd", "Minor 3rd", "Augmented 4th", "Perfect 5th", "Major 6th", "Minor 7th"],
            PhrygianDominant: ["Root", "Minor 2nd", "Major 3rd", "Perfect 4th", "Perfect 5th", "Minor 6th", "Minor 7th"],
            LydianSharp2: ["Root", "Augmented 2nd", "Minor 3rd", "Augmented 4th", "Perfect 5th", "Major 6th", "Major 7th"],
            SuperLocrianBB7: ["Root", "Minor 2nd", "Minor 3rd", "Major 3rd", "Diminished 5th", "Minor 6th", "Diminished 7th"],
            MelodicMinor: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Major 7th"],
            DorianFlat2: ["Root", "Minor 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Minor 7th"],
            LydianAugmented: ["Root", "Major 2nd", "Major 3rd", "Augmented 4th", "Augmented 5th", "Major 6th", "Major 7th"],
            LydianDominant: ["Root", "Major 2nd", "Major 3rd", "Augmented 4th", "Perfect 5th", "Major 6th", "Minor 7th"],
            MixolydianFlat6: ["Root", "Major 2nd", "Major 3rd", "Perfect 4th", "Perfect 5th", "Minor 6th", "Minor 7th"],
            LocrianNat2: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Diminished 5th", "Minor 6th", "Minor 7th"],
            Altered: ["Root", "Minor 2nd", "Minor 3rd", "Major 3rd", "Diminished 5th", "Minor 6th", "Minor 7th"],
            WholeTone: ["Root", "Major 2nd", "Major 3rd", "Augmented 4th", "Augmented 5th", "Major 7th"],
            DiminishedHW: ["Root", "Minor 2nd", "Minor 3rd", "Major 3rd", "Perfect 4th", "Augmented 4th", "Diminished 6th", "Minor 6th"],
            DiminishedWH: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Diminished 5th", "Augmented 5th", "Major 6th", "Augmented 6th"],
            Blues: ["Root", "Minor 3rd", "Perfect 4th", "Diminished 5th", "Perfect 5th", "Minor 7th"],
            BebopMajor: ["Root", "Major 2nd", "Major 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Minor 7th", "Major 7th"],
            BebopDominant: ["Root", "Major 2nd", "Major 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Minor 7th", "Major 7th"],
            BebopDorian: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Minor 7th", "Major 7th"]
        };
        const modePatterns = {
            Ionian: [0, 2, 4, 5, 7, 9, 11],
            Dorian: [0, 2, 3, 5, 7, 9, 10],
            Phrygian: [0, 1, 3, 5, 7, 8, 10],
            Lydian: [0, 2, 4, 6, 7, 9, 11],
            Mixolydian: [0, 2, 4, 5, 7, 9, 10],
            Aeolian: [0, 2, 3, 5, 7, 8, 10],
            Locrian: [0, 1, 3, 5, 6, 8, 10],
            MajorPentatonic: [0, 2, 4, 7, 9],
            MinorPentatonic: [0, 3, 5, 7, 10],
            HarmonicMinor: [0, 2, 3, 5, 7, 8, 11],
            LocrianNat6: [0, 1, 3, 5, 6, 9, 10],
            IonianAug: [0, 2, 4, 5, 8, 9, 11],
            DorianSharp4: [0, 2, 3, 6, 7, 9, 10],
            PhrygianDominant: [0, 1, 4, 5, 7, 8, 10],
            LydianSharp2: [0, 3, 4, 6, 7, 9, 11],
            SuperLocrianBB7: [0, 1, 3, 4, 6, 8, 9],
            MelodicMinor: [0, 2, 3, 5, 7, 9, 11],
            DorianFlat2: [0, 1, 3, 5, 7, 9, 10],
            LydianAugmented: [0, 2, 4, 6, 8, 9, 11],
            LydianDominant: [0, 2, 4, 6, 7, 9, 10],
            MixolydianFlat6: [0, 2, 4, 5, 7, 8, 10],
            LocrianNat2: [0, 2, 3, 5, 6, 8, 10],
            Altered: [0, 1, 3, 4, 6, 8, 10],
            WholeTone: [0, 2, 4, 6, 8, 10],
            DiminishedHW: [0, 1, 3, 4, 6, 7, 9, 10],
            DiminishedWH: [0, 2, 3, 5, 6, 8, 9, 11],
            Blues: [0, 3, 5, 6, 7, 10],
            BebopMajor: [0, 2, 4, 5, 7, 9, 11],
            BebopDominant: [0, 2, 4, 5, 7, 9, 10, 11],
            BebopDorian: [0, 2, 3, 5, 7, 9, 10, 11]
        };
        const modeOffsets = {
            Ionian: 0,
            Dorian: 2,
            Phrygian: 4,
            Lydian: 5,
            Mixolydian: 7,
            Aeolian: 9,
            Locrian: 11
        };
        const chordQualities = {
            Ionian: ["maj", "min", "min", "maj", "maj", "min", "dim"],
            Dorian: ["min", "min", "maj", "maj", "min", "dim", "maj"],
            Phrygian: ["min", "maj", "maj", "min", "dim", "maj", "min"],
            Lydian: ["maj", "maj", "min", "dim", "maj", "min", "min"],
            Mixolydian: ["maj", "min", "dim", "maj", "min", "min", "maj"],
            Aeolian: ["min", "dim", "maj", "min", "min", "maj", "maj"],
            Locrian: ["dim", "maj", "min", "min", "maj", "maj", "min"],
            HarmonicMinor: ["min", "dim", "aug", "min", "maj", "maj", "dim"],
            LocrianNat6: ["dim", "aug", "min", "maj", "maj", "dim", "min"],
            IonianAug: ["aug", "min", "maj", "maj", "dim", "min", "dim"],
            DorianSharp4: ["min", "maj", "maj", "dim", "min", "dim", "aug"],
            PhrygianDominant: ["maj", "maj", "dim", "min", "dim", "aug", "min"],
            LydianSharp2: ["maj", "dim", "min", "dim", "aug", "min", "maj"],
            SuperLocrianBB7: ["dim", "min", "dim", "aug", "min", "maj", "maj"],
            MelodicMinor: ["min", "dim", "aug", "min", "maj", "dim", "dim"],
            DorianFlat2: ["dim", "aug", "min", "maj", "dim", "dim", "min"],
            LydianAugmented: ["aug", "min", "maj", "dim", "dim", "min", "dim"],
            LydianDominant: ["min", "maj", "dim", "dim", "min", "dim", "aug"],
            MixolydianFlat6: ["maj", "dim", "dim", "min", "dim", "aug", "min"],
            LocrianNat2: ["dim", "dim", "min", "dim", "aug", "min", "maj"],
            Altered: ["dim", "min", "dim", "aug", "min", "maj", "dim"]
        };
        const fourNoteQualities = {
            Ionian: ["maj7", "min7", "min7", "maj7", "7", "min7", "min7b5"],
            Dorian: ["min7", "min7", "maj7", "7", "min7", "min7b5", "maj7"],
            Phrygian: ["min7", "maj7", "7", "min7", "min7b5", "maj7", "min7"],
            Lydian: ["maj7", "7", "min7", "min7b5", "maj7", "min7", "min7"],
            Mixolydian: ["7", "min7", "min7b5", "maj7", "min7", "min7", "maj7"],
            Aeolian: ["min7", "min7b5", "maj7", "min7", "min7", "maj7", "7"],
            Locrian: ["min7b5", "maj7", "min7", "min7", "maj7", "7", "min7"],
            HarmonicMinor: ["minmaj7", "m7b5", "7#5", "m7", "maj7", "maj7", "dim7"],
            LocrianNat6: ["m7b5", "7#5", "m7", "maj7", "maj7", "dim7", "minmaj7"],
            IonianAug: ["7#5", "m7", "maj7", "maj7", "dim7", "minmaj7", "m7b5"],
            DorianSharp4: ["m7", "maj7", "maj7", "dim7", "minmaj7", "m7b5", "7#5"],
            PhrygianDominant: ["maj7", "maj7", "dim7", "minmaj7", "m7b5", "7#5", "m7"],
            LydianSharp2: ["maj7", "dim7", "minmaj7", "m7b5", "7#5", "m7", "maj7"],
            SuperLocrianBB7: ["dim7", "minmaj7", "m7b5", "7#5", "m7", "maj7", "maj7"],
            MelodicMinor: ["minmaj7", "m7", "maj7#5", "7", "7", "m7b5", "m7b5"],
            DorianFlat2: ["m7", "maj7#5", "7", "7", "m7b5", "m7b5", "minmaj7"],
            LydianAugmented: ["maj7#5", "7", "7", "m7b5", "m7b5", "minmaj7", "m7"],
            LydianDominant: ["7", "7", "m7b5", "m7b5", "minmaj7", "m7", "maj7#5"],
            MixolydianFlat6: ["7", "m7b5", "m7b5", "minmaj7", "m7", "maj7#5", "7"],
            LocrianNat2: ["m7b5", "m7b5", "minmaj7", "m7", "maj7#5", "7", "7"],
            Altered: ["m7b5", "minmaj7", "m7", "maj7#5", "7", "7", "m7b5"]
        };
        const modeEmotions = {
            Ionian: "Bright, happy, triumphant",
            Dorian: "Soulful, introspective, jazzy",
            Phrygian: "Exotic, tense, mysterious",
            Lydian: "Dreamy, ethereal, floating",
            Mixolydian: "Upbeat, bluesy, rock-oriented",
            Aeolian: "Sad, melancholic, somber",
            Locrian: "Dark, unstable, dissonant",
            MajorPentatonic: "Bright, simple, uplifting",
            MinorPentatonic: "Bluesy, raw, emotional",
            HarmonicMinor: "Exotic, tense, dramatic",
            LocrianNat6: "Dark, mystical, unstable",
            IonianAug: "Mysterious, tense, augmented",
            DorianSharp4: "Modal, suspended, lydian tinge",
            PhrygianDominant: "Flamenco, Spanish, fiery",
            LydianSharp2: "Exotic, otherworldly, tense",
            SuperLocrianBB7: "Dissonant, chaotic, extreme",
            MelodicMinor: "Jazzy, ascending, sophisticated",
            DorianFlat2: "Phrygian-jazzy, dark minor",
            LydianAugmented: "Ethereal, bright tension",
            LydianDominant: "Lydian blues, dominant color",
            MixolydianFlat6: "Dark dominant, melancholic",
            LocrianNat2: "Subdued tension, altered locrian",
            Altered: "Jazzy tension, altered dominant",
            WholeTone: "Ambiguous, dreamy, impressionistic",
            DiminishedHW: "Tense, chromatic, dominant approach",
            DiminishedWH: "Symmetric, melodic, mysterious",
            Blues: "Soulful, gritty, expressive",
            BebopMajor: "Swinging, chromatic, bebop swing",
            BebopDominant: "Jazz dominant, passing tones",
            BebopDorian: "Dorian with swing, modal jazz"
        };

        function getSemitone(note, notation) {
            const sharpMap = { "C": 0, "C#": 1, "D": 2, "D#": 3, "E": 4, "F": 5, "F#": 6, "G": 7, "G#": 8, "A": 9, "A#": 10, "B": 11 };
            const flatMap = { "C": 0, "Db": 1, "D": 2, "Eb": 3, "E": 4, "F": 5, "Gb": 6, "G": 7, "Ab": 8, "A": 9, "Bb": 10, "B": 11 };
            return (notation === 'flat' ? flatMap : sharpMap)[note] || 0;
        }

        function getNoteFromSemitone(semitone, notation) {
            return (notation === 'flat' ? flatNotes : sharpNotes)[semitone];
        }

        function getGuitarStrings(tuning) {
            const tunings = {
                standard: [
                    ["E", 2], ["A", 2], ["D", 3], ["G", 3], ["B", 3], ["E", 4]
                ],
                dropd: [
                    ["D", 2], ["A", 2], ["D", 3], ["G", 3], ["B", 3], ["E", 4]
                ],
                openg: [
                    ["D", 2], ["G", 2], ["D", 3], ["G", 3], ["B", 3], ["D", 4]
                ],
                dadgad: [
                    ["D", 2], ["A", 2], ["G", 3], ["D", 3], ["A", 3], ["D", 4]
                ],
                opend: [
                    ["D", 2], ["A", 2], ["D", 3], ["F#", 3], ["A", 3], ["D", 4]
                ],
                openc: [
                    ["C", 2], ["G", 2], ["C", 3], ["G", 3], ["C", 4], ["E", 4]
                ],
                doubledropd: [
                    ["D", 2], ["A", 2], ["D", 3], ["G", 3], ["B", 3], ["D", 4]
                ]
            };
            const tuningConfig = tunings[tuning] || tunings.standard;
            return tuningConfig.map(([note, octave]) => ({
                note,
                octave,
                semitone: getSemitone(note, currentNotation)
            }));
        }

        function generateChords(notes, mode) {
            const triads = [], fourNote = [], fiveNote = [], sixNote = [];
            if (chordQualities[mode] && notes.length >= 3) {
                const num = Math.min(notes.length, 7);
                for (let i = 0; i < num; i++) {
                    triads.push(`${notes[i]}${chordQualities[mode][i]}`);
                    let q = fourNoteQualities[mode][i];
                    fourNote.push(`${notes[i]}${q}`);
                    fiveNote.push(`${notes[i]}${q.replace("7", "9")}`);
                    sixNote.push(`${notes[i]}${q.replace("7", "11")}`);
                }
            }
            return { triads, fourNote, fiveNote, sixNote };
        }

        function generateData(notation) {
            const notesList = notation === 'sharp' ? sharpNotes : flatNotes;
            const data = {};
            for (let rootName of notesList) {
                const rootSemitone = getSemitone(rootName, notation);
                data[rootName] = {};
                for (let mode of modes) {
                    const pattern = modePatterns[mode];
                    const notes = pattern.map(p => getNoteFromSemitone((rootSemitone + p) % 12, notation));
                    const chords = generateChords(notes, mode);
                    data[rootName][mode] = {
                        notes,
                        intervals: intervalPatterns[mode],
                        triads: chords.triads,
                        fourNote: chords.fourNote,
                        fiveNote: chords.fiveNote,
                        sixNote: chords.sixNote
                    };
                }
            }
            return data;
        }

        function updateKeySelect() {
            const keySelect = document.getElementById('keySelect');
            keySelect.innerHTML = '';
            const notesList = currentNotation === 'sharp' ? sharpNotes : flatNotes;
            notesList.forEach(note => {
                const option = document.createElement('option');
                option.value = note;
                option.textContent = note;
                keySelect.appendChild(option);
            });
            keySelect.value = notesList.includes('C') ? 'C' : notesList[0];
        }

        function getRelativeModes(key, mode) {
            if (!modeOffsets[mode]) return [];
            const rootSemitone = getSemitone(key, currentNotation);
            const modeOffset = modeOffsets[mode];
            const parentIonianSemitone = (rootSemitone - modeOffset + 12) % 12;
            const relatives = [];
            Object.keys(modeOffsets).forEach(relMode => {
                const relOffset = modeOffsets[relMode];
                const relKeySemitone = (parentIonianSemitone + relOffset) % 12;
                const relKey = getNoteFromSemitone(relKeySemitone, currentNotation);
                if (`${relKey} ${relMode}` !== `${key} ${mode}`) {
                    relatives.push(`${relKey} ${relMode}`);
                }
            });
            return relatives;
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r}, ${g}, ${b}`;
        }

        function drawFretboard(notes) {
            const canvas = document.getElementById('fretboardCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const guitarStrings = getGuitarStrings(currentTuning);
            const stringSpacing = canvas.height / 6;
            const fretSpacing = canvas.width / 14; // 13 frets + nut
            const noteRadius = 15;
            const stringOrder = currentStringOrder === 'lowBottom' ? guitarStrings.slice().reverse() : guitarStrings;

            // Draw strings
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 2;
            for (let i = 0; i < 6; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * stringSpacing + stringSpacing / 2);
                ctx.lineTo(canvas.width, i * stringSpacing + stringSpacing / 2);
                ctx.stroke();
            }

            // Draw frets (nut at x=0, fret 1 at x=fretSpacing, etc.)
            for (let i = 0; i <= 13; i++) {
                ctx.lineWidth = (i === 1) ? 4 : 2; // Thicker line for fret 1
                ctx.beginPath();
                ctx.moveTo(i * fretSpacing, 0);
                ctx.lineTo(i * fretSpacing, canvas.height);
                ctx.stroke();
            }

            // Draw fret 1 label
            ctx.fillStyle = themeColor;
            ctx.font = '10px Roboto';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText('Fret 1', fretSpacing, 10);

            // Draw fret markers at frets 3, 5, 7, 9, 12
            const markers = [3, 5, 7, 9, 12];
            ctx.fillStyle = '#888';
            markers.forEach(fret => {
                if (fret === 12) {
                    ctx.beginPath();
                    ctx.arc(fret * fretSpacing + fretSpacing / 2, stringSpacing * 1.5, 10, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(fret * fretSpacing + fretSpacing / 2, stringSpacing * 4.5, 10, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.beginPath();
                    ctx.arc(fret * fretSpacing + fretSpacing / 2, canvas.height / 2, 10, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            // Draw fret numbers
            ctx.fillStyle = themeColor;
            ctx.font = '10px Roboto';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            for (let i = 0; i <= 12; i++) {
                ctx.fillText(i, i * fretSpacing + fretSpacing / 2, canvas.height + 5);
            }

            // Draw open string labels
            ctx.fillStyle = themeColor;
            ctx.font = 'bold 12px Roboto';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            stringOrder.forEach((string, stringIndex) => {
                const label = `${string.note}${string.octave}`;
                ctx.fillText(label, 10, stringIndex * stringSpacing + stringSpacing / 2);
            });

            // Draw mode notes (including open strings and fret 1)
            ctx.fillStyle = themeColor;
            ctx.font = '12px Roboto';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            stringOrder.forEach((string, stringIndex) => {
                const baseSemitone = getSemitone(string.note, currentNotation);
                for (let fret = 0; fret <= 12; fret++) {
                    const semitone = (baseSemitone + fret) % 12;
                    const note = getNoteFromSemitone(semitone, currentNotation);
                    if (notes.includes(note)) {
                        const x = fret * fretSpacing + fretSpacing / 2;
                        const y = stringIndex * stringSpacing + stringSpacing / 2;
                        ctx.beginPath();
                        ctx.arc(x, y, noteRadius, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.fillStyle = '#1a1a1a';
                        ctx.fillText(note, x, y);
                        ctx.fillStyle = themeColor;
                    }
                }
            });
        }

        function drawPianoRoll(notes) {
            const canvas = document.getElementById('pianoCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const blackKeyOffsets = [0, 1, 3, 4, 5];
            const themeColorRgb = hexToRgb(themeColor);

            const numWhiteKeys = 14; // 2 octaves
            const keyWidth = canvas.width / numWhiteKeys;
            const blackKeyHeight = canvas.height * 0.65;

            // Which octave each white key belongs to
            const startingOctave = 3;

            // --- White Keys ---
            for (let i = 0; i < numWhiteKeys; i++) {
                const x = i * keyWidth;
                const note = whiteKeys[i % 7];
                const octave = startingOctave + Math.floor(i / 7);
                const fullNote = note + octave;

                // Gradient fill
                const grad = ctx.createLinearGradient(x, 0, x, canvas.height);
                grad.addColorStop(0, "#fafafa");
                grad.addColorStop(1, "#dcdcdc");
                ctx.fillStyle = grad;
                ctx.strokeStyle = "#444";
                ctx.lineWidth = 1.2;
                ctx.beginPath();
                ctx.roundRect(x, 0, keyWidth, canvas.height, 3);
                ctx.fill();
                ctx.stroke();

                // Highlight if active
                if (notes.includes(note)) {
                    ctx.fillStyle = `rgba(${themeColorRgb},0.35)`;
                    ctx.fillRect(x, 0, keyWidth, canvas.height);
                }

                // Label
                ctx.font = notes.includes(note) ? 'bold 12px Roboto' : '11px Roboto';
                ctx.fillStyle = notes.includes(note) ? themeColor : "#333";
                ctx.textAlign = 'center';
                ctx.fillText(fullNote, x + keyWidth / 2, canvas.height - 12);
            }

            // --- Black Keys ---
            for (let i = 0; i < numWhiteKeys; i++) {
                const note = whiteKeys[i % 7];
                const octave = startingOctave + Math.floor(i / 7);

                if (blackKeyOffsets.includes(i % 7)) {
                    const x = (i + 1) * keyWidth - keyWidth / 4;
                    const grad = ctx.createLinearGradient(x, 0, x, blackKeyHeight);
                    grad.addColorStop(0, "#333");
                    grad.addColorStop(1, "#000");
                    ctx.fillStyle = grad;
                    ctx.strokeStyle = "#111";
                    ctx.beginPath();
                    ctx.roundRect(x - keyWidth / 4, 0, keyWidth / 2, blackKeyHeight, 3);
                    ctx.fill();
                    ctx.stroke();

                    // Black note name (C# / Db depending on setting)
                    const semitone = (getSemitone(note, 'sharp') + 1) % 12;
                    const blackNote = getNoteFromSemitone(semitone, currentNotation) + octave;

                    // Highlight if active
                    if (notes.includes(getNoteFromSemitone(semitone, currentNotation))) {
                        ctx.fillStyle = `rgba(${themeColorRgb},0.6)`;
                        ctx.fillRect(x - keyWidth / 4, 0, keyWidth / 2, blackKeyHeight);
                    }

                    // Label
                    ctx.font = notes.includes(getNoteFromSemitone(semitone, currentNotation)) ? 'bold 11px Roboto' : '10px Roboto';
                    ctx.fillStyle = notes.includes(getNoteFromSemitone(semitone, currentNotation)) ? themeColor : "#eee";
                    ctx.textAlign = 'center';
                    ctx.fillText(blackNote, x, blackKeyHeight - 10);
                }
            }
        }

        function updateTable() {
            const key = document.getElementById('keySelect').value;
            const mode = document.getElementById('modeSelect').value;
            if (!modesData[key] || !modesData[key][mode]) return;
            const data = modesData[key][mode];
            const relativeModes = getRelativeModes(key, mode);
            let relativeHtml = `You have selected <span>${key} ${mode}</span>`;
            if (relativeModes.length > 0) {
                relativeHtml += `, which is also the same note structure as: ${relativeModes.join(", ")}`;
            } else {
                relativeHtml += `, a non-diatonic scale.`;
            }
            document.getElementById('relativeModes').innerHTML = relativeHtml;
            document.getElementById('fretboardKeyMode').innerHTML = `(${key} ${mode})`;
            document.getElementById('pianoKeyMode').innerHTML = `(${key} ${mode})`;
            let tableHtml = `
                <tr><td>Notes</td><td>${data.notes.join(", ")}</td></tr>
                <tr><td>Intervals</td><td>${data.intervals.join(", ")}</td></tr>
                <tr><td>Emotion/Feeling</td><td>${modeEmotions[mode] || "N/A"}</td></tr>
            `;
            if (data.triads.length > 0) {
                tableHtml += `<tr><td>Triads</td><td>${data.triads.join(", ")}</td></tr>`;
            }
            if (data.fourNote.length > 0) {
                tableHtml += `<tr><td>Four-Note Chords</td><td>${data.fourNote.join(", ")}</td></tr>`;
            }
            if (data.fiveNote.length > 0) {
                tableHtml += `<tr><td>Five-Note Chords</td><td>${data.fiveNote.join(", ")}</td></tr>`;
            }
            if (data.sixNote.length > 0) {
                tableHtml += `<tr><td>Six-Note Chords</td><td>${data.sixNote.join(", ")}</td></tr>`;
            }
            document.getElementById('tableBody').innerHTML = tableHtml;
            drawFretboard(data.notes);
            drawPianoRoll(data.notes);
        }

        document.addEventListener("DOMContentLoaded", () => {
            currentNotation = 'sharp';
            currentTuning = 'standard';
            currentStringOrder = 'highBottom';
            themeColor = '#00ffcc';
            document.documentElement.style.setProperty('--theme-color', themeColor);
            document.documentElement.style.setProperty('--theme-color-rgb', hexToRgb(themeColor));
            modesData = generateData(currentNotation);
            updateKeySelect();
            document.getElementById('notationSelect').addEventListener('change', (e) => {
                currentNotation = e.target.value;
                modesData = generateData(currentNotation);
                updateKeySelect();
                updateTable();
            });
            document.getElementById('tuningSelect').addEventListener('change', (e) => {
                currentTuning = e.target.value;
                updateTable();
            });
            document.getElementById('stringOrderSelect').addEventListener('change', (e) => {
                currentStringOrder = e.target.value;
                updateTable();
            });
            document.getElementById('themeColor').addEventListener('input', (e) => {
                themeColor = e.target.value;
                document.documentElement.style.setProperty('--theme-color', themeColor);
                document.documentElement.style.setProperty('--theme-color-rgb', hexToRgb(themeColor));
                updateTable();
            });
            document.getElementById('keySelect').addEventListener('change', updateTable);
            document.getElementById('modeSelect').addEventListener('change', updateTable);
            updateTable();
        });
    </script>
</body>
</html>